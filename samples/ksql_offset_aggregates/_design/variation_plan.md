# ksql_offset_aggregates バリエーション設計

🗕 2025年6月27日（JST）
🧐 作業者: 詩音（テストエンジニアAI）

## 目的

`LATEST_BY_OFFSET` と `EARLIEST_BY_OFFSET` を例に、DSLの習熟度に応じたサンプルケースを段階的に構成する。学習者が順に試しながら理解を深められることを目指す。

## 段階別プラン

### 1. 最新注文の単純取得
- **ガイドレベル**: Beginner
- **シナリオ**: 単一の `Orders` ストリームから、各顧客の最新注文を取得する。
- **学び**: `LatestByOffset` の基本形を体験。シンプルな選択と出力を確認する。

### 2. 顧客ごとの最新集計
- **ガイドレベル**: Beginner
- **シナリオ**: `GroupBy` を利用し、顧客単位で最新注文金額を集計。
- **学び**: グルーピングと集計結果のマッピング。DSLの `GroupBy` ～ `Aggregate` 基本操作。

### 3. 先頭注文との比較集計
- **ガイドレベル**: Intermediate
- **シナリオ**: 最新注文と初回注文 (`EarliestByOffset`) を同時に取得し、差額を算出する。
- **学び**: `LatestByOffset` と `EarliestByOffset` の組み合わせ。計算式の組み込み方法。

### 4. Entity Framework クエリとの対比
- **ガイドレベル**: Intermediate
- **シナリオ**: 同じ集計処理を Entity Framework (EF) で記述し、生成SQLとDSL生成KSQLを比較。
- **学び**: KSQL DSL の記述とEFの違い、クエリ変換結果の確認ポイント。

### 5. 複数ストリーム結合を含む高度応用
- **ガイドレベル**: Advanced
- **シナリオ**: `Orders` と `Customers` ストリームをJOINし、最新注文および最初の注文情報を合わせて出力する。
- **学び**: JOINを含む複雑なDSL構造の組み立て。テスト設計上の検証観点（遅延、欠損値など）。

## コメント

各段階でサンプルコードと確認用テストケースを用意することで、DSL構文の理解とKSQL変換結果の検証が行いやすくなる。教育的価値を高めるため、段階が進むごとに要素を少しずつ増やし、実運用に近いシナリオへと発展させる計画とする。
